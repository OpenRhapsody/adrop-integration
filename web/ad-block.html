<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Adrop AdBlock Test</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto 0;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        h2 {
            color: #333;
            margin-top: 0;
        }

        .example-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .example-section h3 {
            color: #007bff;
            margin-top: 0;
        }

        .ad-container {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 320px;
            height: 100px;
            overflow: hidden;
            position: relative;
        }

        .blocked-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffebee;
            border: 2px solid #ff4444;
            border-radius: 5px;
            box-sizing: border-box;
            display: none;
            justify-content: center;
            align-items: center;
            color: #d32f2f;
            font-weight: bold;
            font-size: 14px;
        }

        .blocked-message small {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        .disclaimer {
            background-color: #ffebee;
            border: 1px solid #ff4444;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            color: #c62828;
        }

        .disclaimer strong {
            color: #d32f2f;
        }

        .disclaimer-section h3 {
            color: #d32f2f !important;
            border-bottom: 2px solid #ff4444 !important;
        }

        .disclaimer-item {
            background-color: #fff;
            border: 1px solid #ff9999;
            border-radius: 5px;
            padding: 12px;
            margin: 10px 0;
            color: #333;
        }

        .disclaimer-item strong {
            color: #c62828;
            display: block;
            margin-bottom: 5px;
        }

        .disclaimer-section p strong {
            color: #c62828;
        }
    </style>
    <script>
        // Detect specific error type for asset loading failures
        async function detectErrorType(src) {
            // Check if network is available
            if (!navigator.onLine) {
                return 'Network Offline'
            }

            // Try different approaches to identify the cause
            try {
                // First try with CORS mode to detect actual server response
                const response = await fetch(src, { method: 'HEAD', mode: 'cors' })
                if (!response.ok) {
                    return `Server Error (${response.status})`
                }
                return 'Server Accessible (Unknown Image Error)'
            } catch (corsError) {
                // If CORS fails, try no-cors to see if it's blocked entirely
                try {
                    await fetch(src, { method: 'HEAD', mode: 'no-cors' })
                    return 'CORS Policy Restriction'
                } catch (blockError) {
                    // If both fail, likely blocked by ad blocker
                    if (blockError.name === 'TypeError') {
                        return 'Blocked (Likely AdBlocker)'
                    }
                    return `Network Error (${blockError.message})`
                }
            }
        }

        // Listen for asset error events
        document.addEventListener('adrop:assetError', async function(event) {
            console.log('üö® Asset Error Detected!')
            console.log('Asset ID:', event.detail.id)
            console.log('Asset Source:', event.detail.src)

            const assetId = event.detail.id
            const assetSrc = event.detail.src

            if (!assetId) return

            const assetElement = document.getElementById(assetId)
            if (!assetElement) return

            const container = assetElement.closest('.ad-container')
            if (container && !container.querySelector('.blocked-message')) {
                // Show initial message first
                const blockedMessage = document.createElement('div')
                blockedMessage.className = 'blocked-message'
                blockedMessage.innerHTML = `üö´ Asset Loading Failed<br><small>Detecting cause...</small>`
                blockedMessage.style.display = 'flex'
                blockedMessage.style.flexDirection = 'column'
                container.appendChild(blockedMessage)

                // Analyze specific cause
                const errorType = await detectErrorType(assetSrc)
                blockedMessage.innerHTML = `üö´ Asset Loading Failed<br><small>${errorType}</small>`
            }
        })
    </script>
</head>
<body>

<div class='container'>
    <h1>Adrop AdBlock Test</h1>

    <div class='example-section'>
        <p>This page tests ad blocking situations for Adrop advertisements.</p>

        <h3>Test Instructions:</h3>
        <ol>
            <li><strong>Install AdGuard chrome extension:</strong>
                <a href='https://chromewebstore.google.com/detail/bgnkhhnnamicmpeenaelnjfhikgbkllg?utm_source=item-share-cb' target='_blank'>
                    Install AdGuard
                </a>
            </li>
            <li>Refresh this page after installation</li>
            <li>You can also check detailed error information in the browser console</li>
        </ol>
    </div>

    <div class='example-section'>
        <h3>Test Banner (320x100)</h3>
        <p>Test whether the advertisement below is blocked by AdGuard.</p>

        <div class='ad-container'>
            <a class='class-5506e141b0a2a8b9f1cb' rel='noopener noreferrer' target='_blank' href='https://dev.adrop.io' style='width:100%;height:100%;display:flex;justify-content:center;align-items:center'>
                <img id='5506e141b0a2a8b9f1cb' src='https://storage.adrop.io/public/test_templates/Banner_320x100.png' alt='Î∞∞ÎÑà 375x80 dp' style='width:100%;height:100%;object-fit:contain' onclick='fetch("https://api-v2-dev.adrop.io/invoke?action=AD_CLICK&txid=01K2YGRD6Z9MSRCCKSRJMNK007:01K3QRF060FFXQEB3J3PP0D9F6:01K3SNB9TNQ6FSS4KCZAW1YSVY_wUnhI4_m2LVV4TPL1Csvh&auid=01K2YDQ87BH5R0MZCEJEMHGB6F:01K3QKM93YA7H9KRVWC547FTTF:7a639530c57df120197581093f4ae671b44257a35dad54f3f2ef3eb4638d90af&unit=01K3QKMJE1C3R22JY8H4CVPHAB")' onload='(function(){let invoked=!1;const observer=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting&&!invoked){invoked=!0;fetch("https://api-v2-dev.adrop.io/invoke?action=AD_IMPR&txid=01K2YGRD6Z9MSRCCKSRJMNK007:01K3QRF060FFXQEB3J3PP0D9F6:01K3SNB9TNQ6FSS4KCZAW1YSVY_wUnhI4_m2LVV4TPL1Csvh&auid=01K2YDQ87BH5R0MZCEJEMHGB6F:01K3QKM93YA7H9KRVWC547FTTF:7a639530c57df120197581093f4ae671b44257a35dad54f3f2ef3eb4638d90af&unit=01K3QKMJE1C3R22JY8H4CVPHAB")}})},{root:null,rootMargin:"0px",threshold:.5});let element=document.getElementById("5506e141b0a2a8b9f1cb");element&&observer.observe(element)}).call(this)' onerror='(function(){document.dispatchEvent(new CustomEvent("adrop:assetError",{detail:{id:this.id,src:this.src}}))}).call(this)'/>
            </a>
        </div>
    </div>

    <div class='example-section'>
        <h3>Implementation Guide</h3>
        <p>To implement asset error detection in your application, add the following event listener to your page:</p>

        <div style="background: #f4f4f4; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin: 10px 0; overflow-x: auto;">
            <code style="font-family: 'Monaco', 'Consolas', monospace; font-size: 14px;">
document.addEventListener('adrop:assetError', async function(event) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;console.log('üö® Asset Error Detected!')<br>
&nbsp;&nbsp;&nbsp;&nbsp;console.log('Asset ID:', event.detail.id)<br>
&nbsp;&nbsp;&nbsp;&nbsp;console.log('Asset Source:', event.detail.src)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;// Your custom error handling logic here<br>
&nbsp;&nbsp;&nbsp;&nbsp;// e.g., show fallback content, log to analytics, etc.<br>
})
            </code>
        </div>

        <p><strong>Event Details:</strong></p>
        <ul>
            <li><code>event.detail.id</code>: The ID of the failed asset element</li>
            <li><code>event.detail.src</code>: The source URL that failed to load</li>
        </ul>

        <p>This event is triggered by the <code>onerror</code> handler on ad elements when asset loading fails for any reason.</p>
    </div>

    <div class='example-section disclaimer-section'>
        <h3>‚ö†Ô∏è Important Disclaimers</h3>
        <p><strong>Error Detection Accuracy:</strong> The error detection system provides estimates only and is not 100% accurate. Browser security policies and network restrictions make it impossible to definitively distinguish between ad blockers, CORS issues, network errors, and other blocking mechanisms. Results should be interpreted as probable causes rather than definitive diagnoses.</p>

        <p><strong>DOM Manipulation Limitation:</strong> Ad blockers that hide or completely remove ad containers from the DOM cannot be detected by this system. Such cases require direct detection implementation by the client.</p>
    </div>
</div>
</body>
</html>
